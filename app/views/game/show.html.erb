<h2>Setup</h2>
<%= form_with url: "/set_player_count", method: :post do %>
  <label>Number of players:</label>
  <%= select_tag :player_count, options_for_select([2,3,4,5,6,7], @player_count) %>
  <%= submit_tag "Set" %>
<% end %>

<h2>Start New Game</h2>

<% if flash[:alert] %>
  <p style="color: red;"><%= flash[:alert] %></p>
<% end %>

<%= form_with url: "/new_game", method: :post do %>
  <% @player_count.times do |i| %>
    <% default_names = ["Player 1", "Player 2", "Player 3", "Player 4", "Player 5", "Player 6", "Player 7"] %>
    <fieldset style="margin-bottom: 12px; padding: 8px; border: 1px solid $444;">
      <legend>Player <%= i + 1 %></legend>

      <div>
        <label>Name</label><br />
        <%= text_field_tag "players[#{i}][name]", default_names[i] %>
      </div>

      <div style="margin-top: 6px;">
        <label>Faction</label><br />
        <%= select_tag "players[#{i}][faction]", options_for_select(Engine::Catalog::FACTIONS, Engine::Catalog::FACTIONS[i]) %>
      </div>

      <div style="margin-top: 6px;">
        <label>Player Mat</label>
        <%= select_tag "players[#{i}][mat]", options_for_select(Engine::Catalog::PLAYER_MATS, Engine::Catalog::PLAYER_MATS[i % Engine::Catalog::PLAYER_MATS.length]) %>
      </div>
    </fieldset>
  <% end %>

  <%= submit_tag "Start New Game" %>
<% end %>

<p><strong>Turn:</strong> <%= @turn %></p>
<p><strong>Current Player:</strong> <%= @current_player %></p>

<h2>Players</h2>
<ul>
  <% @players.each_with_index do |p, idx| %>
    <li>
      <strong><%= p["name"] %></strong>
      — <%= p["faction"] %> / <%= p["mat"] %>
      | Power: <%= p["power"] %>
      | Popularity: <%= p["popularity"] %>
      | Coins: <%= p["coins"] %>
      <%= "←" if idx == @current_player_index %>
    </li>
  <% end %>
</ul>

<h2>Board</h2>
<ul>
  <% @hexes.each do |hex| %>
    <li>
      <strong><%= hex %></strong>
      —
      <% here = @pieces.select { |pc| pc["hex"] == hex } %>
      <% if here.empty? %>
        (empty)
      <% else %>
        <% here.each do |pc| %>
          <span>
            <%= pc["type"] %> (P<%= pc["owner"] %>)
          </span>
        <% end %>
      <% end %>
      <% res = @resources_by_hex[hex] || 0 %>
      <span> | Resources: <%= res %></span>
    </li>
  <% end %>
</ul>

<h2>Turn Flow</h2>
<p><strong>Step:</strong> <%= @turn_step %></p>

<% if @selected_pair %>
  <p>
    <strong>Selected Column:</strong> <%= @turn_column %> —
    Top: <%= @selected_pair["top"] %>,
    Bottom: <%= @selected_pair["bottom"] %>
  </p>
<% end %>

<h2>Actions</h2>
<% if @pending.present? %>
  <p><strong>Pending:</strong> <%= @pending.inspect %></p>
<% end %>
<ul>
  <% @legal_actions.each do |a| %>
    <li style="margin-bottom: 6px;">
      <% case a["type"] %>
      <% when "CHOOSE_COLUMN" %>
        <% pair = @mat_layout[a["column"]] %>
        <%= button_to "Choose Column #{a["column"]}: #{pair["top"]} / #{pair["bottom"]}",
              "/choose_column", method: :post, params: { column: a["column"] } %>
      <% when "CHOOSE_BOLSTER_REWARD" %>
        <%= button_to "Bolster: #{a["reward"]}", "/choose_bolster_reward", method: :post, params: { reward: a["reward"] } %>
      <% when "SELECT_PIECE" %>
        <%= button_to "Select piece: #{a["piece_id"]}",
              "/select_piece", method: :post, params: { piece_id: a["piece_id"] } %>
      <% when "MOVE_PIECE" %>
        <%= button_to "Move to #{a["to_hex"]}",
              "/move_piece", method: :post, params: { to_hex: a["to_hex"] } %>
      <% when "PRODUCE_AT" %>
        <%= button_to "Produce at #{a["hex"]}",
              "/produce_at", method: :post, params: { hex: a["hex"] } %>
      <% when "DO_BOTTOM" %>
        <%= button_to "Do Bottom Action", "/do_bottom", method: :post %>
      <% when "SKIP_BOTTOM" %>
        <%= button_to "Skip Bottom Action", "/skip_bottom", method: :post %>
      <% when "END_TURN" %>
        <%= button_to "End Turn", "/end_turn", method: :post %>
      <% end %>
    </li>
  <% end %>
</ul>

<%= button_to "Reset Session", "/reset_session", method: :post %>


